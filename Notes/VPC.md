# Virtual Private Cloud (VPC)
A virtual data centre in the cloud. Lets you provision logically isolated sections of your AWS cloud. You have complete control over the envioronment, including setting up your own IP ranges, subnets, and configuration of route tables and network gateways. 
## Features
- 1 subnet can only be in 1 availability zone. 
- VPC can be accessed either through an internet gateway of a virtual private gateway. Traffic hits a router inside the VPC, which is then routes to the right subnet by going through a route table and then through a network access control list. Your instances then sit inside a subnet. 
- Subnets then have different network address ranges, allowing you to assign custom IPs to different subnets. 
- You can then configure route tables between subnets. 
- You can create an internet gateway and attach it to a VPC (can only have 1 per VPC). 
- This gives you much better security controls over AWS resources. 
- Security groups are then able to span subnets.
- Security groups do not span VPCs. 
- Subnet network access control lists can then decide which subnets are able to communicate. 
- Security groups are stateful, whereas network access control lists are stateless. 
- 10.0.0.0/16 gives you the largest address space in VPC. 
- You loose 5 IP addresses in range due to Amazon reserving them for different reasons. 
## Default VPC vs Custom VPC
- Default is user friendly. 
- All subnets in default VPC have a route out to the internet. 
- Each instance in the default VPC gets assigned a public and private IP address. In a custom VPC, if there is no interent access the instances only get assigned private IPs. 
## VPC Peering
- Connect one VPC with another via a direct network route, using private IP addresses. 
- Instances behave as if they are on the same private network. 
- Can peer with other AWS accounts. 
- Peering is in a star configuration: 1 central VPC peers with 4 others, there is no transitive peering. This means no routing through intermediate VPCs. If you need to talk to a VPC you have to directly peer with it. 
## NAT Instances and NAT Gateways 
- On NAT instances, you must disable source/destination checks. 
- In routing table you add a route out with the destination being all addresses, and target being the NAT instance. 
- NAT instance is basically a jump box for a private subnet, that can be used to route traffic through. 
- NAT Gateway sits in public subnet. Then a route is created that allows private instances to speak to the NAT gateway. This allows them to talk to the internet. This works as the NAT gateway is in a subnet that is connected to the internet. 
### NAT Instances 
- Must be in a public subnet. 
- Must be route from public subnet to private subnet. 
- Amount of traffic that can be supported depends on the size of the NAT instance. 
- Can create high availability using auto scaling groups. 
- Sits behind a security group. 
### NAT Gateways 
- Preferred by enterprise. 
- Scale automatically up to 10Gbps. 
- No need to patch. 
- Not associated with security groups. 
- Auto assigned a public IP address.
- Remember to update route tables. 
- More secure than a NAT instance. 
## Network Access Control Lists and Security Groups
- Can only ever have 1 subnet associated with 1 NACL. 
- By default NACL deny everything. 
- Ephemeral ports: post used for client after initial handshake to transfer data over. 
- Rules are evaluated in numerical order. 
- VPC automatically comes with default NACL which allows all inbound/outbound traffic. 
- Each subnet must be associated with a NACL, if not it is associated with the default. 
- NACL can be associated to multiple subnets, but each subnet can only have 1 NACL. 
- Network ACLS have seperate inbound and outbound rules and are stateless, remeber to open outbound rules for ephemeral ports. 
- Block IPs using NACL not security groups. 
- NACL are evaluated before security groups. 
## Custom VPC's and Load Balancers
- When provisioning load balancers you must always be in atleast 2 Availability Zones, and the 2 AZ must be public. 
## VPC Flow Logs
- Captures information about the IP traffic going to and from network interfaces in your VPC, and stores it in CloudWatch. 
- Can be created at 3 levels:
    - VPC.
    - Subnet.
    - Network Interface Level. 
- Cannot enable flow flogs for VPCs that are paired with your VPC unless peer is in your account. 
- Cannot tag a flow log. 
- Once flow log is created, cannot change its configuration.
- Not all IP traffic is monitored:
    - Traffic talking to Amazon DNS.
    - Traffic generated by Windows for Windows License Activation.
    - Traffic for instance meta data.
    - DHCP traffic. 
    - Traffic to reserved IP address for the default VPC router. 
## NATs vs Bastions
- NAT instance is behind a security group, NAT gateways are not. 
- A NAT is used to provide internet traffic to EC2 instances in private subnets. 
- A Bastion is used to securely administer EC2 instances, using SSH or RDP in private subnets (jump box). 
- To make them highly available, have 2 public subnets and use autoscaling groups and then use Route53 an health checks to keep them alive. 
## VPC Endpoints
- Provides a way of talking to other AWS services without going out over the internet. You do not need a NAT. 
- You add an endpoint to your desired service, such as S3, and this creates a route in your subnet routing table. 

## Extra Notes
- Security groups can span subnets. 
- Security groups only exist in a single VPC.
- Create security group that allows required port traffic from the public subnet range, then assign this to private instances that you want to talk to. 
- Use route tables to create network a network route through a NAT (destination 0.0.0.0/0, target your private CIDR subnet). 
- Security group operates at the instance level (first layer of defence) with allow rules only and all rules evaluated before execution decision. NACL operates at the subnet level (second layer of defence), supports allow and deny rules with rules being evaluated in numerical order. 
- Default NACL allows all inbound and outbound traffic automatically. 
- Security group can only allow ports from CIDR source ranges, no blocking and not granular. 
- New NACL by default deny all traffic (opposite of default NACL used when no NACL is specified for a subnet). 
- Always want Bastions in multiple subnets for high availability. Can use things like auto-scaling to make sure they are available.
- 2 types of VPC endpoint: 
    - Attach to single instance through elastic network interface. 
    - Attach gateway endpoint, that can have a route created for it in the route table for all instances in the subnet. 
